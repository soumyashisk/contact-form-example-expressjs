<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Message List</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <h3 class="my-4" id="message"></h3>
      <a href="" id="email"></a>
      <br />
      <br />
      <a href="list.html">Go Back</a>
      <br />
      <br />
      <button id="delete-button" class="btn btn-danger">Delete</button>
    </div>
    <script>
      function showMessage(email, message) {
        document.getElementById("message").innerText = message;
        const emailLink = document.getElementById("email");
        emailLink.href = "mailto:" + email;
        emailLink.innerText = email;
      }
      const url = new URL(window.location.href);
      const id = url.searchParams.get("id");
      if (!id) {
        alert("No message ID provided");
        window.location.href = "/list.html";
      }
      (async () => {
        try {
          const res = await fetch("/messages/" + id);
          const data = await res.json();
          if (data.error) {
            alert("Error: " + data.error);
            window.location.href = "/list.html";
            return;
          }
          const message = data.data;
          showMessage(message.email, message.message);
        } catch (error) {
          alert("Error fetching messages: " + error);
        }
      })();

      function deleteMessage() {
        if (!confirm("Are you sure you want to delete this message?")) {
          // guard clause
          // no -> false, not false -> true
          return;
        }
        (async () => {
          try {
            const res = await fetch("/messages/" + id, {
              method: "DELETE",
            });
            const data = await res.json();
            if (data.success) {
              alert("Message deleted successfully");
              window.location.href = "/list.html";
            } else {
              alert("Failed to delete message");
            }
          } catch (error) {
            alert("Error deleting message: " + error);
          }
        })();
      }
      document.getElementById("delete-button").onclick = deleteMessage;
    </script>
  </body>
</html>
